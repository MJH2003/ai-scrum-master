name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      run_migrations:
        description: 'Run database migrations'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  # ============================================
  # Database Migration
  # ============================================
  migrate:
    name: Database Migration
    runs-on: ubuntu-latest
    if: ${{ inputs.run_migrations }}
    environment: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: backend/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Running Prisma migrations for ${{ inputs.environment }}..."
          npx prisma migrate deploy
          echo "Migrations completed successfully!"

  # ============================================
  # Deploy to Kubernetes
  # ============================================
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [migrate]
    if: always() && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped')
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          kubeconfig: ${{ secrets.KUBECONFIG }}

      - name: Set environment-specific variables
        id: vars
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "namespace=ai-scrum-master" >> $GITHUB_OUTPUT
            echo "replicas=3" >> $GITHUB_OUTPUT
          else
            echo "namespace=ai-scrum-master-staging" >> $GITHUB_OUTPUT
            echo "replicas=1" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Kubernetes
        run: |
          # Update image tag
          kubectl set image deployment/api \
            api=ghcr.io/${{ github.repository }}/api:${{ github.sha }} \
            -n ${{ steps.vars.outputs.namespace }}
          
          # Scale if needed
          kubectl scale deployment/api \
            --replicas=${{ steps.vars.outputs.replicas }} \
            -n ${{ steps.vars.outputs.namespace }}
          
          # Wait for rollout
          kubectl rollout status deployment/api \
            -n ${{ steps.vars.outputs.namespace }} \
            --timeout=300s

      - name: Verify deployment
        run: |
          # Get pod status
          kubectl get pods -l app=api -n ${{ steps.vars.outputs.namespace }}
          
          # Check health endpoint
          POD_NAME=$(kubectl get pods -l app=api -n ${{ steps.vars.outputs.namespace }} -o jsonpath='{.items[0].metadata.name}')
          kubectl exec $POD_NAME -n ${{ steps.vars.outputs.namespace }} -- curl -sf http://localhost:3000/health || exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment to ${{ inputs.environment }} failed!"
          # Add your notification mechanism here (Slack, email, etc.)

  # ============================================
  # Smoke Tests
  # ============================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Set environment URL
        id: url
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "base_url=https://api.ai-scrum-master.com" >> $GITHUB_OUTPUT
          else
            echo "base_url=https://api-staging.ai-scrum-master.com" >> $GITHUB_OUTPUT
          fi

      - name: Health check
        run: |
          response=$(curl -sf "${{ steps.url.outputs.base_url }}/health")
          echo "Health check response: $response"

      - name: Readiness check
        run: |
          response=$(curl -sf "${{ steps.url.outputs.base_url }}/ready")
          echo "Readiness check response: $response"

      - name: API info check
        run: |
          response=$(curl -sf "${{ steps.url.outputs.base_url }}/api/v1")
          echo "API info response: $response"
