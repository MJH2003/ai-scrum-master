// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatar        String?
  passwordHash  String?
  emailVerified DateTime?
  preferences   Json      @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts        Account[]
  projectMembers  ProjectMember[]
  assignedStories Story[]         @relation("AssignedStories")
  assignedTasks   Task[]          @relation("AssignedTasks")
  ownedProjects   Project[]       @relation("ProjectOwner")
  eventLogs       EventLog[]
  chatMessages    ChatMessage[]
  refreshTokens   RefreshToken[]

  @@index([email])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  tokenType         String?
  scope             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// ORGANIZATION & PROJECT
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  plan      String   @default("free")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]

  @@map("organizations")
}

model Project {
  id             String    @id @default(cuid())
  name           String
  description    String?
  slug           String
  organizationId String?
  ownerId        String
  settings       Json      @default("{}")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  archivedAt     DateTime?

  // Relations
  organization  Organization?   @relation(fields: [organizationId], references: [id])
  owner         User            @relation("ProjectOwner", fields: [ownerId], references: [id])
  members       ProjectMember[]
  epics         Epic[]
  stories       Story[]
  tasks         Task[]
  sprints       Sprint[]
  dependencies  Dependency[]
  eventLogs     EventLog[]
  aiProposals   AIProposal[]
  insights      ProjectInsight[]
  chatMessages  ChatMessage[]

  @@unique([organizationId, slug])
  @@index([ownerId])
  @@index([slug])
  @@map("projects")
}

model ProjectMember {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([projectId])
  @@map("project_members")
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// AGILE ENTITIES
// ============================================

model Epic {
  id          String     @id @default(cuid())
  projectId   String
  title       String
  description String?
  status      EpicStatus @default(DRAFT)
  priority    Priority   @default(MEDIUM)
  position    Int        @default(0)
  aiGenerated Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  stories Story[]

  @@index([projectId])
  @@index([projectId, status])
  @@map("epics")
}

enum EpicStatus {
  DRAFT
  ACTIVE
  DONE
}

model Story {
  id                 String      @id @default(cuid())
  projectId          String
  epicId             String?
  title              String
  description        String?
  acceptanceCriteria Json        @default("[]")
  status             StoryStatus @default(BACKLOG)
  priority           Priority    @default(MEDIUM)
  position           Int         @default(0)
  estimate           Int?
  confidence         Int?        @default(50)
  assigneeId         String?
  aiGenerated        Boolean     @default(false)
  aiSuggestions      Json        @default("[]")
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  epic        Epic?        @relation(fields: [epicId], references: [id], onDelete: SetNull)
  assignee    User?        @relation("AssignedStories", fields: [assigneeId], references: [id], onDelete: SetNull)
  tasks       Task[]
  sprintItems SprintItem[]

  @@index([projectId])
  @@index([epicId])
  @@index([projectId, status])
  @@index([assigneeId])
  @@map("stories")
}

enum StoryStatus {
  BACKLOG
  READY
  IN_PROGRESS
  REVIEW
  DONE
}

model Task {
  id          String     @id @default(cuid())
  projectId   String
  storyId     String
  title       String
  description String?
  status      TaskStatus @default(TODO)
  estimate    Int?
  position    Int        @default(0)
  assigneeId  String?
  aiGenerated Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  project  Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  story    Story   @relation(fields: [storyId], references: [id], onDelete: Cascade)
  assignee User?   @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([storyId])
  @@index([assigneeId])
  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// SPRINT MANAGEMENT
// ============================================

model Sprint {
  id        String       @id @default(cuid())
  projectId String
  name      String
  goal      String?
  startDate DateTime?
  endDate   DateTime?
  status    SprintStatus @default(PLANNING)
  capacity  Json         @default("{}")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  project     Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items       SprintItem[]
  insights    ProjectInsight[]
  burndownData BurndownSnapshot[]

  @@index([projectId])
  @@index([projectId, status])
  @@map("sprints")
}

enum SprintStatus {
  PLANNING
  ACTIVE
  COMPLETED
}

model SprintItem {
  id               String    @id @default(cuid())
  sprintId         String
  storyId          String
  addedAt          DateTime  @default(now())
  completedAt      DateTime?
  originalEstimate Int?
  finalEstimate    Int?

  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  story  Story  @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([sprintId, storyId])
  @@index([sprintId])
  @@index([storyId])
  @@map("sprint_items")
}

model BurndownSnapshot {
  id            String   @id @default(cuid())
  sprintId      String
  date          DateTime @default(now())
  totalPoints   Int
  remainingPoints Int
  completedPoints Int
  addedPoints   Int      @default(0)
  removedPoints Int      @default(0)

  sprint Sprint @relation(fields: [sprintId], references: [id], onDelete: Cascade)

  @@index([sprintId])
  @@index([sprintId, date])
  @@map("burndown_snapshots")
}

// ============================================
// DEPENDENCIES
// ============================================

model Dependency {
  id             String         @id @default(cuid())
  projectId      String
  sourceType     EntityType
  sourceId       String
  targetType     EntityType
  targetId       String
  dependencyType DependencyType
  createdAt      DateTime       @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([sourceType, sourceId, targetType, targetId])
  @@index([projectId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
  @@map("dependencies")
}

enum EntityType {
  EPIC
  STORY
  TASK
}

enum DependencyType {
  BLOCKS
  REQUIRES
}

// ============================================
// EVENT LOG (AUDIT TRAIL)
// ============================================

model EventLog {
  id          String    @id @default(cuid())
  projectId   String
  entityType  EntityType
  entityId    String
  action      EventAction
  changes     Json       @default("{}")
  userId      String?
  aiTriggered Boolean    @default(false)
  createdAt   DateTime   @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([projectId, createdAt])
  @@index([entityType, entityId])
  @@map("event_logs")
}

enum EventAction {
  CREATED
  UPDATED
  DELETED
  MOVED
  STATUS_CHANGED
  ASSIGNED
  UNASSIGNED
  SPRINT_ADDED
  SPRINT_REMOVED
}

// ============================================
// AI SYSTEM
// ============================================

model AIProposal {
  id           String         @id @default(cuid())
  projectId    String
  agentType    AIAgentType
  proposalType String
  payload      Json
  status       ProposalStatus @default(PENDING)
  explanation  String?
  evidence     Json           @default("[]")
  createdBy    String?
  reviewedBy   String?
  reviewedAt   DateTime?
  expiresAt    DateTime?
  createdAt    DateTime       @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, status])
  @@map("ai_proposals")
}

enum AIAgentType {
  BACKLOG_GENERATOR
  SPRINT_PLANNER
  PROJECT_ANALYST
  CHAT
}

enum ProposalStatus {
  PENDING
  APPLIED
  REJECTED
  EXPIRED
}

model ProjectInsight {
  id             String       @id @default(cuid())
  projectId      String
  sprintId       String?
  insightType    InsightType
  severity       Severity     @default(INFO)
  title          String
  description    String?
  linkedEntities Json         @default("[]")
  aiExplanation  String?
  acknowledged   Boolean      @default(false)
  createdAt      DateTime     @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sprint  Sprint? @relation(fields: [sprintId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([projectId, insightType])
  @@map("project_insights")
}

enum InsightType {
  VELOCITY
  RISK
  BLOCKER
  SCOPE_CREEP
  DEPENDENCY_ISSUE
  CAPACITY_WARNING
}

enum Severity {
  INFO
  WARNING
  CRITICAL
}

// ============================================
// CHAT SYSTEM
// ============================================

model ChatMessage {
  id         String     @id @default(cuid())
  projectId  String
  userId     String?
  role       ChatRole
  content    String
  context    Json       @default("{}")
  citations  Json       @default("[]")
  actions    Json       @default("[]")
  createdAt  DateTime   @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([projectId, createdAt])
  @@map("chat_messages")
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}
